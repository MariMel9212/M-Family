<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <!-- ANTI-CACHE META TAGS -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>M-Family</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Amatic+SC:wght@400;700&family=Shantell+Sans:wght@600&display=swap" rel="stylesheet">
    
    <style>
        /* BASE STYLES */
        html, body {
            width: 100%;
            max-width: 100%;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* STRICTLY PREVENT HORIZONTAL SCROLL */
            background-color: #f8fafc;
            font-family: 'Manrope', sans-serif;
            color: #1e293b;
        }
        
        /* Container */
        #app-container {
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Global texture */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('./images/texture.jpg');
            background-size: cover;
            opacity: 0.5;
            z-index: -1;
            pointer-events: none;
        }

        .font-hand { font-family: 'Amatic SC', cursive; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .will-change-transform { will-change: transform, opacity, filter; }

        /* TYPING ANIMATION */
        @keyframes typing {
            0%, 100% { transform: translateY(0); opacity: 0.5; }
            50% { transform: translateY(-4px); opacity: 1; }
        }
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    </style>
</head>
<body>

    <!-- APP CONTAINER -->
    <div id="app-container" class="relative w-full min-h-screen pb-24">

        <!-- CONTENT AREA -->
        <main id="app-content">
            <!-- TABS RENDER HERE -->
        </main>

        <!-- STORY VIEWER (OVERLAY) -->
        <div id="story-viewer" class="fixed inset-0 z-[100] bg-white hidden overflow-y-auto overflow-x-hidden no-scrollbar">
            <!-- STORY CONTENT HERE -->
        </div>

        <!-- NAVIGATION -->
        <nav class="fixed bottom-0 left-0 w-full h-[90px] bg-white/90 backdrop-blur-md border-t border-slate-100 flex items-center justify-around px-4 pb-6 z-50">
            <button onclick="switchTab('moments')" class="flex-1 h-full flex flex-col items-center justify-center text-slate-400 hover:text-slate-900 transition-colors gap-1">
                <span class="text-2xl mb-1">üì∏</span>
                <span class="text-[11px] font-bold tracking-wide">–ú–æ–º–µ–Ω—Ç—ã</span>
            </button>
            <button onclick="switchTab('roulette')" class="flex-1 h-full flex flex-col items-center justify-center text-slate-400 hover:text-slate-900 transition-colors gap-1">
                <span class="text-2xl mb-1">üé≤</span>
                <span class="text-[11px] font-bold tracking-wide">–†—É–ª–µ—Ç–∫–∞</span>
            </button>
            <button onclick="switchTab('sos')" class="flex-1 h-full flex flex-col items-center justify-center text-red-400 hover:text-red-600 transition-colors gap-1">
                <span class="text-2xl mb-1">üö®</span>
                <span class="text-[11px] font-bold tracking-wide">SOS</span>
            </button>
        </nav>

    </div>

    <script>
        // TG INIT
        window.onload = function() {
            const tg = window.Telegram.WebApp;
            if (tg) {
                tg.ready();
                try {
                    tg.expand();
                    if (tg.requestFullscreen) tg.requestFullscreen();
                } catch (e) { console.log(e); }
                tg.setHeaderColor('#ffffff');
                tg.setBackgroundColor('#ffffff');
            }
        };

        // DATA
        const ALBUMS = [
            { title: "–°–æ–Ω–Ω–æ–µ —Ü–∞—Ä—Å—Ç–≤–æ", count: "12 —Ñ–æ—Ç–æ", color: "bg-purple-50", emoji: "üí§" },
            { title: "–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è", count: "8 —Ñ–æ—Ç–æ", color: "bg-orange-50", emoji: "üêæ" },
        ];

        // ELEMENTS
        const content = document.getElementById('app-content');
        const storyViewer = document.getElementById('story-viewer');
        const nav = document.querySelector('nav');

        // --- TABS ---
        function switchTab(tab) {
            if(tab === 'moments') renderMoments();
            if(tab === 'roulette') content.innerHTML = `<div class="p-10 text-center font-bold">–†—É–ª–µ—Ç–∫–∞ —Å–∫–æ—Ä–æ...</div>`;
            if(tab === 'sos') content.innerHTML = `<div class="p-10 text-center font-bold text-red-500">SOS –∫–Ω–æ–ø–∫–∞...</div>`;
        }

        function renderMoments() {
            content.innerHTML = `
                <div class="p-6 pt-32"> <!-- Increased top padding for iPhone Safe Area -->
                    <h1 class="text-3xl font-extrabold text-slate-900 mb-2">M-Family v7.86 ‚ù§Ô∏è</h1>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-8">–°–µ–º–µ–π–Ω—ã–π –∞—Ä—Ö–∏–≤</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-24">
                        <!-- STORY CARD -->
                        <div onclick="openStory()" class="aspect-[4/5] bg-blue-50 rounded-3xl p-4 flex flex-col justify-between cursor-pointer border-2 border-blue-100 relative overflow-hidden">
                            <div class="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center text-xl z-10">üèôÔ∏è</div>
                            <div class="z-10">
                                <h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">–ì–æ–¥ –≤ –ú–æ—Å–∫–≤–µ</h3>
                                <p class="text-xs text-slate-500 font-semibold">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è</p>
                            </div>
                        </div>
                        <!-- OTHER ALBUMS -->
                        ${ALBUMS.map(a => `
                            <div class="aspect-[4/5] ${a.color} rounded-3xl p-4 flex flex-col justify-between cursor-pointer">
                                <div class="text-xl">${a.emoji}</div>
                                <div><h3 class="font-bold text-slate-800">${a.title}</h3></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- STORY LOGIC (STICKY SCROLL ANIMATION) ---
        function openStory() {
            storyViewer.classList.remove('hidden');
            nav.style.display = 'none';
            
            storyViewer.innerHTML = `
                <!-- BACK BTN -->
                <button onclick="closeStory()" class="fixed top-4 right-4 z-[60] w-10 h-10 bg-white/80 backdrop-blur rounded-full shadow-lg flex items-center justify-center text-slate-800 font-bold">‚úï</button>

                <!-- WRAPPER: Provides scroll space (300vh) -->
                <div id="hero-wrapper" class="relative w-full h-[300vh] z-30"> <!-- High Z to overlap Map -->
                    
                    <!-- STICKY CONTAINER: Stays visible while we scroll the wrapper -->
                    <div id="hero-sticky" class="sticky top-0 left-0 w-full h-[100dvh] flex flex-col items-center justify-center bg-white overflow-visible z-10 pointer-events-none">
                        
                        <!-- SAFE MASK: Clips horizontal elements (We, Right Box) -->
                        <div class="absolute inset-0 w-full h-full overflow-hidden pointer-events-none">
                            
                            <!-- 1. BACKGROUND TEXTURE -->
                            <img src="./images/texture.jpg" class="absolute inset-0 w-full h-full object-cover z-0 opacity-50" alt="Background">
                            
                            <!-- 5. BG BOXES (Layer 1, z-5) -->
                            <img id="hero-boxes-bg" src="./images/boxes_bg.png" class="absolute left-1/2 bottom-6 w-full z-5 object-contain will-change-transform translate-y-full" style="transform: translate(-50%, 150%);" alt="Boxes BG">

                            <!-- 4. WE (Layer 2, z-15) -->
                            <img id="hero-we" src="./images/we.png" class="absolute right-2 bottom-16 w-[75%] z-15 object-contain will-change-transform translate-x-full" style="transform: translateX(150%);" alt="We">

                            <!-- 3. RIGHT BOX (Layer 3, z-20) -->
                            <img id="hero-box-right" src="./images/box_right.png" class="absolute left-0 -ml-2 bottom-10 w-[40%] z-20 object-contain will-change-transform -translate-x-full" style="transform: translateX(-150%);" alt="Box Right">

                            <!-- 6. KYLIE (Layer 4, z-25) -->
                            <img id="hero-kylie" src="./images/kylie.png" class="absolute left-[58%] bottom-2 w-[55%] z-25 object-contain will-change-transform translate-y-full" style="transform: translate(-50%, 100%);" alt="Kylie">

                            <!-- 7. TEXT STICKER (Layer 5, z-40) -->
                            <div id="hero-sticker" class="absolute top-[13%] left-[5%] w-[320px] z-40 text-left will-change-transform translate-x-[-20px]">
                                <p id="sticker-text" class="text-slate-900 font-extrabold text-2xl leading-snug" style="font-family: 'Shantell Sans', cursive;">
                                    –ù–æ—è–±—Ä—å<br>–ú—ã, –≤–µ—â–∏ –∏ –æ–¥–Ω–∞ –º–∞–ª–µ–Ω—å–∫–∞—è —Å–æ–±–∞–∫–∞ —Å –±–æ–ª—å—à–∏–º–∏ –∞–º–±–∏—Ü–∏—è–º–∏ –≤—Ä—ã–≤–∞–µ–º—Å—è –≤ —Å—Ç–æ–ª–∏—Ü—É.
                                </p>
                            </div>

                            <!-- TITLE -->
                            <h1 id="hero-title" class="relative z-40 text-center text-slate-900 leading-[90%] tracking-tight will-change-transform origin-center top-1/2 -translate-y-1/2" 
                                style="font-family: 'Shantell Sans', cursive; font-weight: 600; font-size: clamp(50px, 15vw, 75px);">
                                –ë–æ–ª—å—à–æ–π<br>–ø–µ—Ä–µ–µ–∑–¥
                            </h1>
                        </div>

                        <!-- 2. BOTTOM BOXES (Layer 4, z-30) -->
                        <div id="hero-boxes-wrapper" class="absolute bottom-0 left-0 w-full h-auto pointer-events-none z-30" style="overflow-x: clip; overflow-y: visible;">
                            <div id="hero-boxes-bottom" class="relative left-1/2 w-[130%] flex justify-center will-change-transform translate-y-full" style="transform: translate(-50%, 100%);">
                                <img src="./images/boxes_bottom.png" class="w-full h-auto object-contain block" alt="Boxes Bottom">
                            </div>
                        </div>
                        
                    </div>
                </div>

                <!-- BLOCK 2: MAP -->
                <div id="map-block" class="relative w-full min-h-[100vh] bg-white flex flex-col items-center overflow-hidden z-10">
                    <img src="./images/texture.jpg" class="absolute inset-0 w-full h-full object-cover opacity-50 z-0" alt="Texture">
                    <img id="map-bg" src="./images/map_full.png" class="absolute inset-0 w-full h-full object-cover opacity-5 mix-blend-multiply z-10 transition-transform duration-[10s] ease-out scale-90" alt="Map Background">
                    
                    <div class="relative z-20 w-full h-full flex flex-col items-start justify-end min-h-[100vh] p-6 pb-32 pl-10">
                        <!-- POLAROID CONTAINER (Bottom Left) -->
                        <div id="map-polaroid" class="relative bg-white p-3 pb-8 shadow-2xl rotate-[-3deg] max-w-[280px] w-full transform transition-all duration-1000 ease-out opacity-0 scale-50 translate-y-20">
                            <div id="map-pin-polaroid" class="absolute -top-10 right-1/2 translate-x-1/2 w-24 z-30 drop-shadow-md" style="opacity: 0; transform: scale(2) translateY(-50px);">
                                <img src="./images/pin_red.png" class="w-full h-auto" alt="Pin">
                            </div>
                            <div class="aspect-square w-full overflow-hidden bg-slate-100 mb-3 flex items-center justify-center">
                                <img src="./images/kylie_car.jpg" class="w-full h-full object-cover" alt="Kylie in Car">
                            </div>
                            <h2 class="text-xl font-bold text-slate-800 font-hand text-center text-slate-600 leading-tight">
                                –¢—ã—Å—è—á–∞ –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤ –ø–æ–∑–∞–¥–∏...
                            </h2>
                        </div>
                        
                        <!-- POLAROID 2 (Top Right) -->
                        <div id="map-polaroid-2" class="absolute top-[15%] right-[5%] z-25 bg-white p-3 pb-8 shadow-2xl rotate-[6deg] max-w-[240px] w-full transform transition-all duration-1000 ease-out opacity-0 scale-50 translate-y-20">
                            <div id="map-pin-polaroid-2" class="absolute -top-9 left-1/2 -translate-x-1/2 w-24 z-30 drop-shadow-md" style="opacity: 0; transform: scaleX(-1) scale(2) translateY(-50px);">
                                <img src="./images/pin_red.png" class="w-full h-auto" alt="Pin">
                            </div>
                            <div class="aspect-square w-full overflow-hidden bg-slate-100 mb-3">
                                <img src="./images/kylie2.jpg" class="w-full h-full object-cover" alt="Kylie 2">
                            </div>
                             <h2 class="text-lg font-bold text-slate-800 font-hand text-center text-slate-600 leading-tight">
                                ...–í–ø–µ—Ä–µ–¥–∏ ‚Äî –Ω–æ–≤–∞—è –∂–∏–∑–Ω—å!
                            </h2>
                        </div>
                    </div>
                </div>

                <!-- TRANSITION TEXT: Between Map and Elevator -->
                <div id="transition-text-block" class="relative w-full z-25 bg-transparent" style="margin-top: -130px; margin-bottom: -60px;">
                    <div class="relative w-full px-6 py-20">
                        <img src="./images/texture.jpg" class="absolute inset-0 w-full h-full object-cover opacity-50 z-0" alt="Texture">
                        <div id="elevator-sticker" class="relative z-10 w-[90%] max-w-[400px] mx-auto text-center">
                            <p id="elevator-text" class="text-slate-900 leading-snug font-black text-2xl md:text-3xl drop-shadow-sm" style="font-family: 'Shantell Sans', cursive; font-weight: 900;">
                                –†–∞–Ω—å—à–µ –º—ã –ø—Ä–∏–µ–∑–∂–∞–ª–∏ –≤ –ú–æ—Å–∫–≤—É —Ç–æ–ª—å–∫–æ –ø–æ –¥–µ–ª–∞–º.<br>–ù–æ –≤ —ç—Ç–æ—Ç —Ä–∞–∑ –º—ã –µ—Ö–∞–ª–∏ –≤ —Å–≤–æ–π –Ω–æ–≤—ã–π <span class="text-red-600 uppercase">–î–û–ú</span>.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- BLOCK 3: ELEVATOR -->
                <!-- Increased height to 700vh to fit the extended sequence -->
                <div id="elevator-wrapper" class="relative w-full h-[700vh] z-20">
                    
                    <!-- STICKY CONTAINER -->
                    <div id="elevator-sticky" class="sticky top-0 left-0 w-full h-[100dvh] flex flex-col items-center justify-center overflow-hidden">
                        
                        <!-- INTERNAL WRAPPER: CLIPS WIDE CONTENT (Doors, Background) -->
                        <div class="absolute inset-0 w-full h-full overflow-hidden">
                            
                            <!-- 1. BACKGROUND WALL -->
                            <div class="absolute inset-0 w-full h-full z-0 bg-white">
                                 <img src="./images/texture.jpg" class="absolute inset-0 w-full h-full object-cover opacity-50" alt="Texture">
                            </div>

                            <!-- 1.5. ELEVATOR INTERIOR -->
                            <div id="elevator-interior" class="absolute top-0 left-0 w-full h-full z-10 bg-slate-900 opacity-0 shadow-2xl origin-center will-change-transform">
                                 <img id="elevator-photo" src="./images/kylie_elevator_final.jpg?v=final" class="absolute inset-0 w-full h-full object-cover object-center opacity-100 will-change-transform" alt="Kylie Inside">
                            </div>

                            <!-- 3. ELEVATOR DOORS -->
                            <div id="door-left" class="absolute top-0 left-0 w-1/2 h-full bg-gradient-to-r from-zinc-400 via-zinc-200 to-zinc-400 z-30 transform -translate-x-full border-r border-zinc-500 shadow-2xl will-change-transform flex items-center justify-end">
                                <div class="w-4 h-full bg-gradient-to-r from-transparent to-black/10"></div>
                            </div>
                            <div id="door-right" class="absolute top-0 right-0 w-1/2 h-full bg-gradient-to-l from-zinc-400 via-zinc-200 to-zinc-400 z-30 transform translate-x-full border-l border-zinc-500 shadow-2xl will-change-transform flex items-center justify-start">
                                <div class="w-4 h-full bg-gradient-to-l from-transparent to-black/10"></div>
                            </div>

                            <!-- 4. FLOOR PANEL -->
                            <div id="elevator-panel" class="absolute top-[20%] left-1/2 -translate-x-1/2 z-40 bg-zinc-900 border-4 border-zinc-600 rounded-lg p-4 px-8 shadow-2xl opacity-0 transform scale-90 will-change-transform">
                                <div class="flex items-center gap-4">
                                    <div class="text-green-500 text-4xl animate-pulse">‚ñ≤</div>
                                    <div id="floor-count" class="font-mono text-6xl text-red-500 tracking-widest font-bold">01</div>
                                </div>
                            </div>

                            <!-- CHAT CONTAINER -->
                            <div id="chat-container" class="absolute bottom-0 left-0 w-full px-5 pb-[12vh] flex flex-col justify-end gap-3 z-50 pointer-events-none max-w-full overflow-hidden">
                                
                                <!-- KYLIE ROW -->
                                <div class="w-full flex items-end gap-3">
                                    <!-- KYLIE AVATAR TARGET -->
                                    <div id="kylie-avatar-target" class="w-12 h-12 flex-shrink-0 rounded-full overflow-hidden border-2 border-white opacity-0 transition-opacity duration-75">
                                        <img src="./images/kylie_elevator_final.jpg?v=final" class="w-full h-full object-cover" alt="Kylie Avatar">
                                    </div>

                                    <!-- BUBBLE WRAPPER -->
                                    <div class="relative max-w-[70%]">
                                        <!-- TYPING INDICATOR -->
                                        <div id="chat-bubble-typing" class="absolute left-0 bottom-0 bg-white p-3 px-4 rounded-2xl rounded-bl-none shadow-sm filter drop-shadow-sm transition-all duration-300 transform origin-bottom-left scale-0 opacity-0 z-50">
                                             <div class="flex gap-1">
                                                <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                                                <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                                                <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                                             </div>
                                             <svg class="absolute -bottom-[0px] -left-[9px] w-[20px] h-[20px] text-white fill-current z-[-1]" viewBox="0 0 20 20">
                                                 <path d="M20 0v20H0c5 0 10-5 12-10s8-10 8-10z"/>
                                             </svg>
                                        </div>

                                        <!-- MESSAGE BUBBLE -->
                                        <div id="chat-bubble-1" class="bg-white p-3 px-4 rounded-2xl rounded-bl-none shadow-sm filter drop-shadow-sm opacity-0 scale-90 origin-bottom-left transition-all duration-500 z-50">
                                            <p class="text-xs font-bold text-[#5790df] mb-1">–ö–∞–π–ª–∏ üê∂</p>
                                            <p class="text-[15px] text-slate-900 leading-snug">
                                                –í –ø—Ä–æ—à–ª–æ–º –¥–æ–º–µ –º–Ω–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏–ª–æ—Å—å –ø–æ–¥–Ω–∏–º–∞—Ç—å—Å—è –ø–æ —Å—Ç—É–ø–µ–Ω—å–∫–∞–º. –ù–æ –≤ –Ω–æ–≤–æ–º –¥–æ–º–µ —è —Ç–µ–ø–µ—Ä—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –∫–∞—Ç–∞—é—Å—å –≤ –ª–∏—Ñ—Ç–µ!
                                            </p>
                                            <p class="text-[10px] text-slate-400 text-right mt-1">18:30</p>
                                            <svg class="absolute -bottom-[0px] -left-[9px] w-[20px] h-[20px] text-white fill-current z-[-1]" viewBox="0 0 20 20">
                                                <path d="M20 0v20H0c5 0 10-5 12-10s8-10 8-10z"/>
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                <!-- HUSBAND ROW -->
                                <div id="chat-row-2" class="w-full flex justify-end items-end gap-3">
                                    <!-- MESSAGE BUBBLE -->
                                    <div id="husband-bubble" class="relative bg-[#EEFFDE] p-3 px-4 rounded-2xl rounded-br-none shadow-sm filter drop-shadow-sm max-w-[70%] opacity-0 transform scale-0 origin-bottom-right transition-all duration-500">
                                        <p class="text-[15px] text-slate-900 leading-snug">
                                            –ú–æ—è —Å–∞–º–∞—è –ª—é–±–∏–º–∞—è –º–æ—Å–∫–≤–∏—á–∫–∞! –ì–æ—Ä–∂—É—Å—å —Ç–æ–±–æ–π ‚ù§Ô∏è
                                        </p>
                                        <div class="flex items-center justify-end gap-1 mt-1">
                                            <p class="text-[10px] text-[#539e55]">18:31</p>
                                            <span class="text-[#539e55] text-[10px]">‚úì‚úì</span>
                                        </div>
                                        <svg class="absolute -bottom-[0px] -right-[9px] w-[20px] h-[20px] text-[#EEFFDE] fill-current z-[-1] transform scale-x-[-1]">
                                            <path d="M20 0v20H0c5 0 10-5 12-10s8-10 8-10z"/>
                                        </svg>
                                    </div>

                                    <!-- AVATAR -->
                                    <div id="husband-avatar" class="w-12 h-12 rounded-full overflow-hidden shadow-sm flex-shrink-0 bg-slate-200 opacity-0 transform scale-0 transition-all duration-500 border-2 border-white">
                                        <img src="./images/husband_avatar.jpg?v=2" class="w-full h-full object-cover" alt="Husband">
                                    </div>
                                </div>
                            </div>

                            <!-- 7. REPLY BUTTON -->
                            <div class="absolute bottom-[8vh] left-0 w-full flex justify-center z-[110]">
                                 <button id="reply-btn" onclick="handleReply()" class="bg-[#3390ec] text-white px-6 py-3 rounded-full shadow-lg font-bold text-lg flex items-center gap-2 transform transition-all duration-300 opacity-0 scale-90 translate-y-10 hover:scale-105 active:scale-95 pointer-events-auto">
                                    <span>‚úçÔ∏è</span> –û—Ç–≤–µ—Ç–∏—Ç—å
                                </button>
                            </div>
                        
                        </div> <!-- END INTERNAL WRAPPER -->

                    </div>
                </div>

                <!-- BLOCK 4: NEW YEAR / HOME -->
                <div id="home-block" class="relative w-full min-h-[100vh] z-30 bg-white overflow-hidden">
                    <img src="./images/texture.jpg" class="absolute inset-0 w-full h-full object-cover opacity-50 z-0 pointer-events-none" alt="Texture">
                    <!-- Branch 1: Left side - rotated 5deg -->
                    <img id="branch-tl" src="./images/tree_branch.png" class="absolute -top-12 -left-12 w-60 z-10 opacity-90 will-change-transform pointer-events-none" style="transform: translateX(-100%) rotate(5deg); transform-origin: right center;" alt="Branch">
                    
                    <!-- Branch 2: Top Right - Mirrored -->
                    <img id="branch-tr" src="./images/tree_branch.png" class="absolute -top-12 -right-12 w-60 z-10 opacity-90 will-change-transform pointer-events-none" style="transform: translateX(100%) scaleX(-1) rotate(5deg); transform-origin: left center;" alt="Branch">
                    
                    <!-- Commented out other branches for step-by-step adjustment -->
                    <!--
                    <img id="branch-tr" src="./images/tree_branch.png" class="absolute -top-12 -right-12 w-80 z-10 opacity-90 rotate-90 scale-x-[-1] will-change-transform pointer-events-none" style="transform: translate(100%, -100%);" alt="Branch">
                    <img id="branch-bl" src="./images/tree_branch.png" class="absolute -bottom-12 -left-12 w-64 z-10 opacity-90 -rotate-180 will-change-transform pointer-events-none" style="transform: translate(-100%, 100%);" alt="Branch">
                    -->
                    
                    <div class="relative z-10 p-6 flex flex-col items-center justify-center min-h-[50vh] pt-32">
                        <h2 id="home-title" class="text-3xl font-extrabold text-slate-900 text-center mb-4 opacity-0 translate-y-10 transition-all duration-1000 ease-out" style="font-family: 'Shantell Sans', cursive;">
                            –ù–∞—à –ø–µ—Ä–≤—ã–π –ø—Ä–∞–∑–¥–Ω–∏–∫ –∑–¥–µ—Å—å
                        </h2>
                    </div>
                </div>
            `;

            // --- ANIMATION LOGIC ---
            const wrapper = document.getElementById('hero-wrapper');
            const title = document.getElementById('hero-title');
            const boxesBottom = document.getElementById('hero-boxes-bottom'); 
            const boxesBg = document.getElementById('hero-boxes-bg');
            const boxRight = document.getElementById('hero-box-right');
            const weLayer = document.getElementById('hero-we');
            const kylieLayer = document.getElementById('hero-kylie');
            const stickerLayer = document.getElementById('hero-sticker');
            
            const mapBg = document.getElementById('map-bg');
            const mapPolaroid = document.getElementById('map-polaroid');
            const mapPolaroid2 = document.getElementById('map-polaroid-2');
            const mapPinPolaroid = document.getElementById('map-pin-polaroid'); 
            const mapPinPolaroid2 = document.getElementById('map-pin-polaroid-2');
            
const elevatorWrapper = document.getElementById('elevator-wrapper');
                            const doorLeft = document.getElementById('door-left');
            const doorRight = document.getElementById('door-right');
            const elevatorPanel = document.getElementById('elevator-panel');
            const floorCount = document.getElementById('floor-count');
            const elevatorInterior = document.getElementById('elevator-interior'); 
            const elevatorPhoto = document.getElementById('elevator-photo'); 
            
            // New Placeholder
            const kylieAvatarTarget = document.getElementById('kylie-avatar-target');
            
            const chatBubbleTyping = document.getElementById('chat-bubble-typing');
            const chatBubble1 = document.getElementById('chat-bubble-1');
            const husbandAvatar = document.getElementById('husband-avatar');
            const husbandBubble = document.getElementById('husband-bubble');
            const replyBtn = document.getElementById('reply-btn');
            
            // Interaction State
            let hasReplied = false;
            
            // Allow global access for onclick
            window.handleReply = function() {
                hasReplied = true;
                if(replyBtn) {
                    replyBtn.style.opacity = '0';
                    replyBtn.style.transform = 'translateY(20px) scale(0.9)'; // Drop down
                    setTimeout(() => replyBtn.style.display = 'none', 300);
                }
                
                // Show Husband Sequence
                if(husbandAvatar) {
                    husbandAvatar.style.opacity = '1';
                    husbandAvatar.style.transform = 'scale(1)';
                }
                
                setTimeout(() => {
                    if(husbandBubble) {
                        husbandBubble.style.opacity = '1';
                        husbandBubble.style.transform = 'scale(1)';
                    }
                }, 300); // Slight delay for bubble
            };

const homeBlock = document.getElementById('home-block');
                            const branchTL = document.getElementById('branch-tl');
                            const branchTR = document.getElementById('branch-tr');
                            // const branchBL = document.getElementById('branch-bl');
                            const homeTitle = document.getElementById('home-title');
                            
                            const transitionTextBlock = document.getElementById('transition-text-block');

            const viewer = document.getElementById('story-viewer');

            // PREPARE TEXT SPLITTING
            const stickerText = document.getElementById('sticker-text');
            if (stickerText) {
                const text = stickerText.innerText;
                stickerText.innerHTML = text.split('').map(char => {
                    if (char === '\n') return '<br>'; 
                    return `<span class="opacity-0 transition-opacity duration-75">${char}</span>`;
                }).join('');
            }
const stickerSpans = stickerText ? stickerText.querySelectorAll('span') : [];

            // RE-ADDED: Text splitting for Elevator/Transition text
            const elevatorText = document.getElementById('elevator-text');
            if (elevatorText) {
                const processNode = (node) => {
                    if (node.nodeType === 3) { // Text node
                        const chars = node.nodeValue.split('');
                        const spanString = chars.map(c => `<span class="opacity-0 transition-opacity duration-75">${c}</span>`).join('');
                        const wrapper = document.createElement('span');
                        wrapper.innerHTML = spanString;
                        node.replaceWith(...wrapper.childNodes);
                    } else if (node.nodeType === 1) { // Element node
                        if (node.tagName === 'BR') return; // Skip BRs
                        Array.from(node.childNodes).forEach(processNode); // Recurse
                    }
                };
                Array.from(elevatorText.childNodes).forEach(processNode);
            }
            const elevatorSpans = elevatorText ? elevatorText.querySelectorAll('span.opacity-0') : [];

            const getVal = (progress, startAt, duration, startVal, endVal) => {
                if (progress <= startAt) return startVal;
                if (progress >= startAt + duration) return endVal;
                const p = (progress - startAt) / duration;
                return startVal + (p * (endVal - startVal));
            };

            const onScroll = () => {
                if (!wrapper || !viewer) return;
                
                const scrollY = viewer.scrollTop; 
                const viewportHeight = window.innerHeight;
                
                // --- BLOCK 1: HERO ---
                const heroHeight = wrapper.offsetHeight;
                const heroScrollable = heroHeight - viewportHeight;
                
                let progress = 0;
                if (heroScrollable > 0) {
                    progress = Math.max(0, Math.min(1, scrollY / heroScrollable));
                }

                if (title) {
                    const y = -progress * 200; 
                    const scale = 1 + progress * 0.5; 
                    const blur = progress * 20; 
                    const opacity = Math.max(0, 1 - progress * 2.0); 

                    title.style.transform = `translateY(${y}px) scale(${scale})`;
                    title.style.filter = `blur(${blur}px)`;
                    title.style.opacity = opacity;
                }

                if (boxesBottom) {
                    const boxesY = getVal(progress, 0.2, 0.4, 100, 30); 
                    boxesBottom.style.transform = `translate(-50%, ${boxesY}%)`;
                }

                if (boxesBg) {
                    const bgY = getVal(progress, 0.3, 0.4, 150, 0);
                    boxesBg.style.transform = `translate(-50%, ${bgY}%)`;
                }

                if (boxRight) {
                    const boxX = getVal(progress, 0.4, 0.3, -150, 0);
                    boxRight.style.transform = `translateX(${boxX}%)`;
                    
                    if (stickerLayer) {
                         const stickerX = getVal(progress, 0.4, 0.3, -50, 0);
                         stickerLayer.style.transform = `translateX(${stickerX}px)`;
                    }
                }
                
                if (weLayer) {
                    const weX = getVal(progress, 0.5, 0.3, 150, 0); 
                    weLayer.style.transform = `translateX(${weX}%) scaleX(-1)`;
                }

                if (kylieLayer) {
                    const kylieY = getVal(progress, 0.5, 0.3, 100, 0);
                    kylieLayer.style.transform = `translate(-50%, ${kylieY}%) scaleX(-1)`;
                }
                
                if (stickerSpans.length > 0) {
                     const start = 0.8;
                     const end = 0.98;
                     const totalDur = end - start;
                     let localP = 0;
                     if (progress > start) localP = Math.min(1, (progress - start) / totalDur);
                     
                     const totalChars = stickerSpans.length;
                     stickerSpans.forEach((span, i) => {
                         const charProgress = (localP * totalChars) - i;
                         let opacity = 0;
                         if (charProgress >= 1) opacity = 1;
                         else if (charProgress > 0) opacity = charProgress;
                         span.style.opacity = opacity;
                     });
                }

                // --- BLOCK 2: MAP ANIMATION ---
                const mapOffset = heroHeight; 
                const distIntoMap = scrollY + viewportHeight - mapOffset;
                
                if (distIntoMap > 0) {
                    const mapProgress = Math.min(1, distIntoMap / (viewportHeight * 1.2));
                    
                    if (mapPolaroid2) {
                        const start = 0.2;
                        const dur = 0.3;
                        let pPol2 = 0;
                        if (mapProgress > start) pPol2 = Math.min(1, (mapProgress - start) / dur);
                        
                        const polScale = 0.5 + (pPol2 * 0.5);
                        const polY = (1 - pPol2) * 100;
                        const polRot = 6;
                        
                        mapPolaroid2.style.opacity = pPol2;
                        mapPolaroid2.style.transform = `scale(${polScale}) rotate(${polRot}deg) translateY(${polY}px)`;
                    }

                    if (mapPinPolaroid2) {
                        const start = 0.4;
                        const dur = 0.2;
                        let pPP2 = 0;
                        if (mapProgress > start) pPP2 = Math.min(1, (mapProgress - start) / dur);
                        
                        const ppScale = 2 - pPP2; 
                        const ppY = (1 - pPP2) * -50; 
                        
                        mapPinPolaroid2.style.opacity = pPP2;
                        mapPinPolaroid2.style.transform = `translateX(-50%) scaleX(-1) scale(${ppScale}) translateY(${ppY}px)`;
                    }

                    if (mapPolaroid) {
                        const start = 0.5;
                        const dur = 0.3;
                        let pPol = 0;
                        if (mapProgress > start) pPol = Math.min(1, (mapProgress - start) / dur);
                        
                        const polScale = 0.5 + (pPol * 0.5);
                        const polY = (1 - pPol) * 100;
                        const polRot = -3;
                        
                        mapPolaroid.style.opacity = pPol;
                        mapPolaroid.style.transform = `scale(${polScale}) rotate(${polRot}deg) translateY(${polY}px)`;
                    }

                    if (mapPinPolaroid) {
                        const start = 0.7;
                        const dur = 0.2;
                        let pPP = 0;
                        if (mapProgress > start) pPP = Math.min(1, (mapProgress - start) / dur);
                        
                        const ppScale = 2 - pPP; 
                        const ppY = (1 - pPP) * -50; 
                        
                        mapPinPolaroid.style.opacity = pPP;
                        mapPinPolaroid.style.transform = `translateX(50%) scale(${ppScale}) translateY(${ppY}px)`;
                    }

if (mapBg) {
                        const zoomScale = 0.9 + (mapProgress * 0.2); 
                        mapBg.style.transform = `scale(${zoomScale})`;
                    }
                }
                
                // --- TRANSITION TEXT ANIMATION ---
                if (transitionTextBlock) {
                     const rect = transitionTextBlock.getBoundingClientRect();
                     const viewH = window.innerHeight;
                     // Trigger when it enters viewport
                     if (rect.top < viewH && rect.bottom > 0) {
                         const p = 1 - (rect.top / viewH); // 0 when just entering, 1 when at top
                         // Animate spans
                         if (elevatorSpans.length > 0) {
                             const totalSpans = elevatorSpans.length;
                             elevatorSpans.forEach((span, i) => {
                                 // Reveal start at 0.1, end at 0.8
                                 const start = 0.1;
                                 const end = 0.8;
                                 const totalDur = end - start;
                                 
                                 let localP = 0;
                                 if (p > start) localP = Math.min(1, (p - start) / totalDur);
                                 
                                 const charProgress = (localP * totalSpans) - i;
                                 let opacity = 0;
                                 if (charProgress >= 1) opacity = 1;
                                 else if (charProgress > 0) opacity = charProgress;
                                 span.style.opacity = opacity;
                             });
                         }
                     }
                }

                // --- BLOCK 3: ELEVATOR ANIMATION ---
                if (elevatorWrapper) {
                                    const wrapperTop = elevatorWrapper.offsetTop;
                                    const wrapperHeight = elevatorWrapper.offsetHeight;
                                    const scrollable = wrapperHeight - viewportHeight;

                                    if (scrollY >= wrapperTop) {
                        const elevP = Math.min(1, (scrollY - wrapperTop) / scrollable);
                        
                        const closeEnd = 0.1;
                        const rideStart = 0.1;
                        const rideEnd = 0.4;
                        const openStart = 0.4;
                        const openEnd = 0.55;
                        
                        const morphStart = 0.55;
                        const morphEnd = 0.75; 
                        
                        const flyStart = 0.75;
                        const flyEnd = 0.85;

                        // --- DOORS LOGIC ---
                        if (doorLeft && doorRight) {
                            let xLeft = -100;
                            let xRight = 100;
                            
                            if (elevP < openStart) {
                                let pClose = 0;
                                if (elevP > 0) pClose = Math.min(1, elevP / closeEnd);
                                
                                xLeft = -100 + (pClose * 100); 
                                xRight = 100 - (pClose * 100); 
                                
                                if (elevatorInterior) {
                                    if (pClose > 0.9) elevatorInterior.style.opacity = 1;
                                    else if (elevP < 0.05) elevatorInterior.style.opacity = 0; 
                                }

                            } else {
                                let pOpen = Math.min(1, (elevP - openStart) / (openEnd - openStart));
                                xLeft = -(pOpen * 100); 
                                xRight = (pOpen * 100); 
                                if (elevatorInterior) elevatorInterior.style.opacity = 1;
                            }
                            
                            doorLeft.style.transform = `translateX(${xLeft}%)`;
                            doorRight.style.transform = `translateX(${xRight}%)`;
                        }
                        
                        // --- FLOOR PANEL ---
                        if (elevatorPanel && floorCount) {
                            let panelOpacity = 0;
                            if (elevP > rideStart && elevP < rideEnd) panelOpacity = 1;
                            else if (elevP > (rideStart - 0.05) && elevP <= rideStart) panelOpacity = (elevP - (rideStart - 0.05)) / 0.05;
                            else if (elevP >= rideEnd && elevP < (rideEnd + 0.05)) panelOpacity = 1 - (elevP - rideEnd) / 0.05;
                            
                            elevatorPanel.style.opacity = panelOpacity;
                            
                            if (elevP > rideStart) {
                                const rideP = Math.min(1, (elevP - rideStart) / (rideEnd - rideStart));
                                const currentFloor = 1 + Math.floor(rideP * 8); 
                                floorCount.innerText = currentFloor.toString().padStart(2, '0');
                            }
                        }

                        // --- AVATAR ROUNDING ---
                        if (elevatorInterior) {
                            elevatorInterior.style.top = '0px';
                            elevatorInterior.style.left = '0px';
                            elevatorInterior.style.width = '100%';
                            elevatorInterior.style.height = '100%';
                            
                            const winW = window.innerWidth;
                            const winH = window.innerHeight;
                            const centerX = winW / 2;
                            const centerY = winH / 2;
                            
                            const midDiameter = Math.min(winW, winH) * 0.70; 
                            const midRadius = midDiameter / 2;
                            
                            // v7.76 FIX: DYNAMIC TARGET CALCULATION
                            // Use the placeholder element to get exact target coordinates
                            let targetX = 0;
                            let targetY = 0;
                            let targetScale = 0.1; // fallback
                            
                            if (kylieAvatarTarget) {
                                const rect = kylieAvatarTarget.getBoundingClientRect();
                                // We need coordinates relative to the VIEWPORT, which rect provides.
                                // BUT elevatorInterior is fixed/sticky inside the wrapper.
                                // elevatorInterior is absolute top-0 left-0 in the sticky container.
                                // The sticky container is ... sticky top-0.
                                // So rect.left and rect.top are correct relative to the sticky container (viewport).
                                
                                targetX = rect.left + (rect.width / 2);
                                targetY = rect.top + (rect.height / 2);
                                
                                // Scale: Target is w-12 (48px). Mid circle is midDiameter.
                                // targetScale = 48 / midDiameter
                                targetScale = rect.width / midDiameter;
                            } else {
                                // Fallback if element not found
                                targetX = 40;
                                targetY = winH - 100;
                            }

                            if (elevP <= morphStart) {
                                elevatorInterior.style.webkitClipPath = 'circle(150% at 50% 50%)'; 
                                elevatorInterior.style.clipPath = 'circle(150% at 50% 50%)';
                                elevatorInterior.style.transform = 'none'; 
                                if (elevatorPhoto) elevatorPhoto.style.transform = 'scale(1)'; 
                                
                            } else if (elevP > morphStart && elevP <= morphEnd) {
                                elevatorInterior.style.transform = 'none'; 
                                
                                let pRound = (elevP - morphStart) / (morphEnd - morphStart);
                                const startRadius = Math.sqrt(winW*winW + winH*winH) / 2;
                                const curRadius = startRadius - (pRound * (startRadius - midRadius));
                                
                                const clipVal = `circle(${curRadius}px at 50% 50%)`;
                                elevatorInterior.style.webkitClipPath = clipVal;
                                elevatorInterior.style.clipPath = clipVal;
                                
                                if (elevatorPhoto) {
                                    const scale = 1.0 - (pRound * 0.29); 
                                    elevatorPhoto.style.transform = `scale(${scale})`;
                                }

                            } else if (elevP > flyStart) {
                                let pFly = (elevP - flyStart) / (flyEnd - flyStart);
                                if (pFly > 1) pFly = 1;
                                
                                const clipVal = `circle(${midRadius}px at 50% 50%)`;
                                elevatorInterior.style.webkitClipPath = clipVal;
                                elevatorInterior.style.clipPath = clipVal;
                                if (elevatorPhoto) elevatorPhoto.style.transform = 'scale(0.71)';
                                
                                const curScale = 1.0 - (pFly * (1.0 - targetScale));
                                
                                const dx = targetX - centerX;
                                const dy = targetY - centerY;
                                
                                let curDx = pFly * dx;
                                let curDy = pFly * dy;
                                
                                elevatorInterior.style.transform = `translate(${curDx}px, ${curDy}px) scale(${curScale})`;
                            }
                            
                            // v7.78 FIX: HANDOFF TO STATIC AVATAR
                            // When flight is done (or nearly done), hide the flying layer and show the static target.
                            if (elevP > flyEnd && kylieAvatarTarget) {
                                elevatorInterior.style.opacity = '0';
                                kylieAvatarTarget.style.opacity = '1';
                            } else if (elevP > morphStart) {
                                // Ensure it's visible during morph/fly
                                // Only reset if doors are open
                                if (elevP > openEnd) elevatorInterior.style.opacity = '1';
                                if (kylieAvatarTarget) kylieAvatarTarget.style.opacity = '0';
                            }
                        }
                        
                        // --- CHAT ANIMATION SEQUENCE ---
                        
                        // 1. TYPING (0.85 -> 0.89)
                        if (chatBubbleTyping) {
                            if (elevP > 0.85 && elevP < 0.89) {
                                chatBubbleTyping.style.opacity = 1;
                                chatBubbleTyping.style.transform = 'scale(1)';
                            } else {
                                chatBubbleTyping.style.opacity = 0;
                                chatBubbleTyping.style.transform = 'scale(0)';
                            }
                        }

                        // 2. KYLIE BUBBLE (0.89 -> )
                        if (chatBubble1) {
                            if (elevP > 0.89) {
                                chatBubble1.classList.remove('opacity-0', 'scale-90');
                                chatBubble1.classList.add('scale-100');
                                // No dynamic slide needed with Flex layout
                            } else {
                                chatBubble1.classList.add('opacity-0', 'scale-90');
                                chatBubble1.classList.remove('scale-100');
                            }
                        }
                        
                        // 3. HUSBAND APPEARS (MANUAL TRIGGER NOW)
                        // Removed scroll-based trigger for husbandAvatar & husbandBubble
                        
                        // 4. REPLY BUTTON (0.92 -> )
                        if (replyBtn && !hasReplied) {
                             if (elevP > 0.92) {
                                replyBtn.style.opacity = '1';
                                replyBtn.style.transform = 'translateY(0) scale(1)';
                             } else {
                                replyBtn.style.opacity = '0';
                                replyBtn.style.transform = 'translateY(20px) scale(0.9)';
                             }
                        }
                    }
                }

                if (homeBlock) {
                    const rect = homeBlock.getBoundingClientRect();
                    const viewH = window.innerHeight;
                    const startOffset = viewH;
                    const endOffset = viewH * 0.5; 
                    const dist = rect.top; 
                    
                    if (dist < viewH) {
                        const pHome = Math.max(0, Math.min(1, (viewH - dist) / (viewH * 0.6)));
                        const easeP = 1 - Math.pow(1 - pHome, 3);
                        
if (branchTL) {
                                            const x = -100 + (easeP * 100); 
                                            branchTL.style.transform = `translateX(${x}%) rotate(5deg)`;
                                        }
                                        if (branchTR) {
                                            const x = 100 - (easeP * 100); 
                                            branchTR.style.transform = `translateX(${x}%) scaleX(-1) rotate(5deg)`;
                                        }
                        
                        if (homeTitle) {
                            if (pHome > 0.5) {
                                homeTitle.classList.remove('opacity-0', 'translate-y-10');
                            } else {
                                homeTitle.classList.add('opacity-0', 'translate-y-10');
                            }
                        }
                    }
                }
            };

            if (window._heroScrollHandler) window.removeEventListener('scroll', window._heroScrollHandler);
            viewer.addEventListener('scroll', onScroll, { passive: true });
            onScroll();
        }

        function closeStory() {
            const viewer = document.getElementById('story-viewer');
            storyViewer.classList.add('hidden');
            storyViewer.innerHTML = '';
            nav.style.display = 'flex';
        }

        switchTab('moments');

    </script>
</body>
</html>
