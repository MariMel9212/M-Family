<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <!-- ANTI-CACHE META TAGS -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>M-Family</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Amatic+SC:wght@400;700&family=Shantell+Sans:wght@600&display=swap" rel="stylesheet">
    
    <style>
        /* BASE STYLES */
        html, body {
            width: 100%;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
            /* overflow-y is auto by default */
            background-color: #f8fafc;
            font-family: 'Manrope', sans-serif;
            color: #1e293b;
        }
        
        /* Container - allow vertical scroll, clip horizontal */
        #app-container {
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden; /* Reverted to hidden for better support */
        }
        
        /* Global texture */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('./images/texture.jpg');
            background-size: cover;
            opacity: 0.5;
            z-index: -1;
            pointer-events: none;
        }

        .font-hand { font-family: 'Amatic SC', cursive; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .will-change-transform { will-change: transform, opacity, filter; }
    </style>
</head>
<body>

    <!-- APP CONTAINER -->
    <div id="app-container" class="relative w-full min-h-screen pb-24">

        <!-- CONTENT AREA -->
        <main id="app-content">
            <!-- TABS RENDER HERE -->
        </main>

        <!-- STORY VIEWER (OVERLAY) -->
        <div id="story-viewer" class="fixed inset-0 z-[100] bg-white hidden overflow-y-auto no-scrollbar">
            <!-- STORY CONTENT HERE -->
        </div>

        <!-- NAVIGATION -->
        <nav class="fixed bottom-0 left-0 w-full h-[90px] bg-white/90 backdrop-blur-md border-t border-slate-100 flex items-center justify-around px-4 pb-6 z-50">
            <button onclick="switchTab('moments')" class="flex-1 h-full flex flex-col items-center justify-center text-slate-400 hover:text-slate-900 transition-colors gap-1">
                <span class="text-2xl mb-1">üì∏</span>
                <span class="text-[11px] font-bold tracking-wide">–ú–æ–º–µ–Ω—Ç—ã</span>
            </button>
            <button onclick="switchTab('roulette')" class="flex-1 h-full flex flex-col items-center justify-center text-slate-400 hover:text-slate-900 transition-colors gap-1">
                <span class="text-2xl mb-1">üé≤</span>
                <span class="text-[11px] font-bold tracking-wide">–†—É–ª–µ—Ç–∫–∞</span>
            </button>
            <button onclick="switchTab('sos')" class="flex-1 h-full flex flex-col items-center justify-center text-red-400 hover:text-red-600 transition-colors gap-1">
                <span class="text-2xl mb-1">üö®</span>
                <span class="text-[11px] font-bold tracking-wide">SOS</span>
            </button>
        </nav>

    </div>

    <script>
        // TG INIT
        window.onload = function() {
            const tg = window.Telegram.WebApp;
            if (tg) {
                tg.ready();
                try {
                    tg.expand();
                    if (tg.requestFullscreen) tg.requestFullscreen();
                } catch (e) { console.log(e); }
                tg.setHeaderColor('#ffffff');
                tg.setBackgroundColor('#ffffff');
            }
        };

        // DATA
        const ALBUMS = [
            { title: "–°–æ–Ω–Ω–æ–µ —Ü–∞—Ä—Å—Ç–≤–æ", count: "12 —Ñ–æ—Ç–æ", color: "bg-purple-50", emoji: "üí§" },
            { title: "–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è", count: "8 —Ñ–æ—Ç–æ", color: "bg-orange-50", emoji: "üêæ" },
        ];

        // ELEMENTS
        const content = document.getElementById('app-content');
        const storyViewer = document.getElementById('story-viewer');
        const nav = document.querySelector('nav');

        // --- TABS ---
        function switchTab(tab) {
            if(tab === 'moments') renderMoments();
            if(tab === 'roulette') content.innerHTML = `<div class="p-10 text-center font-bold">–†—É–ª–µ—Ç–∫–∞ —Å–∫–æ—Ä–æ...</div>`;
            if(tab === 'sos') content.innerHTML = `<div class="p-10 text-center font-bold text-red-500">SOS –∫–Ω–æ–ø–∫–∞...</div>`;
        }

        function renderMoments() {
            content.innerHTML = `
                <div class="p-6 pt-32"> <!-- Increased top padding for iPhone Safe Area -->
                    <h1 class="text-3xl font-extrabold text-slate-900 mb-2">M-Family v6.23 ‚ù§Ô∏è</h1>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-8">–°–µ–º–µ–π–Ω—ã–π –∞—Ä—Ö–∏–≤</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-24">
                        <!-- STORY CARD -->
                        <div onclick="openStory()" class="aspect-[4/5] bg-blue-50 rounded-3xl p-4 flex flex-col justify-between cursor-pointer border-2 border-blue-100 relative overflow-hidden">
                            <div class="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center text-xl z-10">üèôÔ∏è</div>
                            <div class="z-10">
                                <h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">–ì–æ–¥ –≤ –ú–æ—Å–∫–≤–µ</h3>
                                <p class="text-xs text-slate-500 font-semibold">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è</p>
                            </div>
                        </div>
                        <!-- OTHER ALBUMS -->
                        ${ALBUMS.map(a => `
                            <div class="aspect-[4/5] ${a.color} rounded-3xl p-4 flex flex-col justify-between cursor-pointer">
                                <div class="text-xl">${a.emoji}</div>
                                <div><h3 class="font-bold text-slate-800">${a.title}</h3></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- STORY LOGIC (STICKY SCROLL ANIMATION) ---
        function openStory() {
            storyViewer.classList.remove('hidden');
            nav.style.display = 'none';
            
            storyViewer.innerHTML = `
                <!-- BACK BTN -->
                <button onclick="closeStory()" class="fixed top-4 right-4 z-[60] w-10 h-10 bg-white/80 backdrop-blur rounded-full shadow-lg flex items-center justify-center text-slate-800 font-bold">‚úï</button>

                <!-- WRAPPER: Provides scroll space (300vh) -->
                <div id="hero-wrapper" class="relative w-full h-[300vh] z-30"> <!-- High Z to overlap Map -->
                    
                    <!-- STICKY CONTAINER: Stays visible while we scroll the wrapper -->
                    <!-- Changed back to 'sticky' so it scrolls away when wrapper ends -->
                    <!-- overflow-visible to allow overlap of bottom boxes -->
                    <div id="hero-sticky" class="sticky top-0 left-0 w-full h-[100dvh] flex flex-col items-center justify-center bg-white overflow-visible z-10 pointer-events-none">
                        
                        <!-- SAFE MASK: Clips horizontal elements (We, Right Box) -->
                        <div class="absolute inset-0 w-full h-full overflow-hidden pointer-events-none">
                            
                            <!-- 1. BACKGROUND TEXTURE -->
                            <img src="./images/texture.jpg" class="absolute inset-0 w-full h-full object-cover z-0 opacity-50" alt="Background">
                            
                            <!-- 5. BG BOXES (Layer 1, z-5) - INSIDE MASK -->
                            <!-- Lowered base position to bottom-0 and translate-y to 150% to ensure hidden -->
                            <img id="hero-boxes-bg" src="./images/boxes_bg.png" class="absolute left-1/2 bottom-0 w-full z-5 object-contain will-change-transform translate-y-full" style="transform: translate(-50%, 150%);" alt="Boxes BG">

                            <!-- 4. WE (Layer 2, z-15) - INSIDE MASK -->
                            <!-- Moved to RIGHT edge, reduced size -->
                            <img id="hero-we" src="./images/we.png" class="absolute right-[-10%] bottom-10 w-[60%] z-15 object-contain will-change-transform translate-x-full" style="transform: translateX(100%);" alt="We">

                            <!-- 3. RIGHT BOX (Layer 3, z-20) - INSIDE MASK -->
                            <img id="hero-box-right" src="./images/box_right.png" class="absolute right-0 bottom-10 w-[40%] z-20 object-contain will-change-transform translate-x-[150%]" alt="Box Right">

                            <!-- 6. KYLIE (Layer 4, z-25) - INSIDE MASK -->
                            <!-- Increased width to 85% -->
                            <img id="hero-kylie" src="./images/kylie.png" class="absolute left-[58%] bottom-0 w-[85%] z-25 object-contain will-change-transform translate-y-full" style="transform: translate(-50%, 100%);" alt="Kylie">

                            <!-- 7. TEXT STICKER (Layer 5, z-40) - INSIDE MASK -->
                            <!-- Top Left, Letter Reveal Animation -->
                            <!-- Moved to left-[5%], text-left -->
                            <div id="hero-sticker" class="absolute top-[13%] left-[5%] w-[280px] z-40 text-left will-change-transform translate-x-[-20px]">
                                <!-- Shantell Sans Font -->
                                <p id="sticker-text" class="text-slate-900 font-extrabold text-2xl leading-snug" style="font-family: 'Shantell Sans', cursive;">
                                    –ù–æ—è–±—Ä—å. –ú—ã, –≤–µ—â–∏ –∏ –æ–¥–Ω–∞ –º–∞–ª–µ–Ω—å–∫–∞—è —Å–æ–±–∞–∫–∞ —Å –±–æ–ª—å—à–∏–º–∏ –∞–º–±–∏—Ü–∏—è–º–∏ –≤—Ä—ã–≤–∞–µ–º—Å—è –≤ —Å—Ç–æ–ª–∏—Ü—É.
                                </p>
                            </div>

                            <!-- TITLE (Single block for Smoke Animation) - INSIDE MASK -->
                            <h1 id="hero-title" class="relative z-40 text-center text-slate-900 leading-[90%] tracking-tight will-change-transform origin-center top-1/2 -translate-y-1/2" 
                                style="font-family: 'Shantell Sans', cursive; font-weight: 600; font-size: clamp(50px, 15vw, 75px);">
                                –ë–æ–ª—å—à–æ–π<br>–ø–µ—Ä–µ–µ–∑–¥
                            </h1>
                        </div>

                        <!-- 2. BOTTOM BOXES (Layer 4, z-30) - OUTSIDE MASK -->
                        <!-- Allows vertical overlap with next section -->
                        <!-- FIX: Changed width to 150% and centered to be bigger -->
                        <div id="hero-boxes-bottom" class="absolute bottom-0 left-1/2 w-[150%] -translate-x-1/2 flex justify-center z-30 will-change-transform translate-y-full pointer-events-none">
                            <img src="./images/boxes_bottom.png" class="w-full max-w-none h-auto object-contain" alt="Boxes Bottom">
                        </div>
                        
                    </div>
                </div>

                <!-- BLOCK 2: MAP (Naturally follows the 300vh wrapper) -->
                <!-- z-10 to be UNDER Hero overlap -->
                <div class="relative w-full min-h-[100vh] bg-white py-20 px-6 flex flex-col items-center overflow-hidden z-10">
                     <!-- Background -->
                    <img src="./images/texture.jpg" class="absolute inset-0 w-full h-full object-cover opacity-50">
                    
                    <div class="relative z-10 bg-white p-4 shadow-xl rotate-2 max-w-sm w-full mt-10">
                        <img src="./images/map_full.png" class="w-full h-auto bg-slate-200">
                        <p class="mt-4 text-center font-hand font-bold text-xl">–ú—ã –µ—Ö–∞–ª–∏, –µ—Ö–∞–ª–∏...</p>
                    </div>
                </div>
            `;

            // --- ANIMATION LOGIC ---
            const wrapper = document.getElementById('hero-wrapper');
            const title = document.getElementById('hero-title');
            const boxesBottom = document.getElementById('hero-boxes-bottom');
            const boxesBg = document.getElementById('hero-boxes-bg');
            const boxRight = document.getElementById('hero-box-right');
            const weLayer = document.getElementById('hero-we');
            const kylieLayer = document.getElementById('hero-kylie');
            const stickerLayer = document.getElementById('hero-sticker');
            const viewer = document.getElementById('story-viewer');

            // PREPARE TEXT SPLITTING
            const stickerText = document.getElementById('sticker-text');
            if (stickerText) {
                const text = stickerText.innerText;
                stickerText.innerHTML = text.split('').map(char => `<span class="opacity-0 transition-opacity duration-75">${char}</span>`).join('');
            }
            const stickerSpans = stickerText ? stickerText.querySelectorAll('span') : [];

            // Helper for interpolation
            const getVal = (progress, startAt, duration, startVal, endVal) => {
                if (progress <= startAt) return startVal;
                if (progress >= startAt + duration) return endVal;
                const p = (progress - startAt) / duration;
                return startVal + (p * (endVal - startVal));
            };

            const onScroll = () => {
                if (!wrapper || !viewer || !title) return;
                
                const scrollY = viewer.scrollTop; 
                const viewportHeight = window.innerHeight;
                const scrollableDistance = wrapper.offsetHeight - viewportHeight; 
                
                let progress = 0;
                if (scrollableDistance > 0) {
                    progress = Math.max(0, Math.min(1, scrollY / scrollableDistance));
                }

                // 1. TITLE ANIMATION: Smoke / Blur Up (0 -> 0.5)
                const y = -progress * 200; 
                const scale = 1 + progress * 0.5; 
                const blur = progress * 20; 
                const opacity = Math.max(0, 1 - progress * 2.0); 

                title.style.transform = `translateY(${y}px) scale(${scale})`;
                title.style.filter = `blur(${blur}px)`;
                title.style.opacity = opacity;

                // 2. BOTTOM BOXES: Slide Up (0.2 -> 0.6)
                // Final position: 30% (Even Lower)
                if (boxesBottom) {
                    const boxesY = getVal(progress, 0.2, 0.4, 100, 30); 
                    boxesBottom.style.transform = `translateY(${boxesY}%)`;
                }

                // 3. BG BOXES: Slide Up (0.3 -> 0.7) (PARALLEL WITH OTHERS)
                // From 150% (hidden) to 0% (visible at bottom)
                if (boxesBg) {
                    const bgY = getVal(progress, 0.3, 0.4, 150, 0);
                    // We must preserve -50% X translation for centering
                    boxesBg.style.transform = `translate(-50%, ${bgY}%)`;
                }

                // 4. RIGHT BOX & STICKER: Slide In From Right (0.4 -> 0.7)
                if (boxRight) {
                    const boxX = getVal(progress, 0.4, 0.3, 150, 0);
                    boxRight.style.transform = `translateX(${boxX}%)`;
                    
                    // Sync sticker container slide with box (subtle slide)
                    if (stickerLayer) {
                         // Slide from 50px to 0px
                         const stickerX = getVal(progress, 0.4, 0.3, 50, 0);
                         stickerLayer.style.transform = `translateX(${stickerX}px)`;
                    }
                }
                
                // 5. WE: Slide In From RIGHT (0.5 -> 0.8)
                if (weLayer) {
                    // Final position: 0% (Right edge)
                    // Start: 100% (Hidden to right)
                    const weX = getVal(progress, 0.5, 0.3, 100, 0); 
                    weLayer.style.transform = `translateX(${weX}%)`;
                }

                // 6. KYLIE: Slide Up (0.5 -> 0.8) - Shifted earlier
                if (kylieLayer) {
                    const kylieY = getVal(progress, 0.5, 0.3, 100, 0);
                    // Preserve X centering
                    kylieLayer.style.transform = `translate(-50%, ${kylieY}%)`;
                }
                
                // STICKER TEXT: Smooth Letter Reveal (0.8 -> 1.0) - STARTS AFTER KYLIE
                if (stickerSpans.length > 0) {
                     // Total duration for text reveal
                     const start = 0.8;
                     const end = 0.98; // Finish just before scroll ends
                     const totalDur = end - start;
                     
                     // We map global progress to local text progress (0 -> 1)
                     let localP = 0;
                     if (progress > start) localP = Math.min(1, (progress - start) / totalDur);
                     
                     // Reveal letters based on localP
                     // If localP is 0.5, half letters should be visible
                     const totalChars = stickerSpans.length;
                     const visibleCount = Math.floor(localP * totalChars);
                     
                     stickerSpans.forEach((span, i) => {
                         // Simple hard cutoff for now, or soft fade?
                         // Let's do a soft threshold
                         const charProgress = (localP * totalChars) - i; // How far past this char index are we?
                         // if charProgress > 1 -> fully visible
                         // if charProgress < 0 -> hidden
                         // if 0..1 -> fading in
                         
                         let opacity = 0;
                         if (charProgress >= 1) opacity = 1;
                         else if (charProgress > 0) opacity = charProgress;
                         
                         span.style.opacity = opacity;
                     });
                }
            };

            // Remove old window listener just in case
            if (window._heroScrollHandler) window.removeEventListener('scroll', window._heroScrollHandler);
            
            // Add listener to VIEWER
            viewer.addEventListener('scroll', onScroll, { passive: true });
            
            // Initial call to set state
            onScroll();
        }

        function closeStory() {
            const viewer = document.getElementById('story-viewer');
            // Ideally remove listener, but since we clear innerHTML and hide it...
            // Better cleanliness:
            // We can't easily remove anonymous/local function unless stored.
            // But since DOM is cleared/hidden, it's mostly fine. 
            // For perfection, we should store 'onScroll' reference if we want to remove it from viewer.
            
            storyViewer.classList.add('hidden');
            storyViewer.innerHTML = '';
            nav.style.display = 'flex';
        }

        // INITIAL RENDER
        switchTab('moments');

    </script>
</body>
</html>